#!/bin/bash

# ===================================================================================
# ubuntu-disk-toolkit - Ubuntu Storage & Disk Management Toolkit
# ===================================================================================

set -euo pipefail

# μ¤ν¬λ¦½νΈ μ •λ³΄
SCRIPT_NAME="ubuntu-disk-toolkit"
VERSION="3.0.0"
DESCRIPTION="Ubuntu Storage & Disk Management Toolkit - Enhanced with API Integration"

# κ²½λ΅ μ„¤μ •
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/../lib/common.sh" ]]; then
    LIB_DIR="$SCRIPT_DIR/../lib"
else
    LIB_DIR="/usr/local/lib/ubuntu-disk-toolkit"
fi

# κ³µν†µ λΌμ΄λΈλ¬λ¦¬ λ΅λ“
source "$LIB_DIR/common.sh"
source "$LIB_DIR/ui-functions.sh"

# μƒλ΅μ΄ API λ¨λ“ λ΅λ“
for api_module in "disk-api.sh" "fstab-api.sh" "raid-api.sh"; do
    if [[ -f "$LIB_DIR/$api_module" ]]; then
        source "$LIB_DIR/$api_module"
    else
        print_error "ν•„μ API λ¨λ“μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤: $api_module"
        exit 1
    fi
done

# κΈ°μ΅΄ κΈ°λ¥ λ¨λ“ λ΅λ“ (νΈν™μ„±)
source "$LIB_DIR/disk-functions.sh"
source "$LIB_DIR/raid-functions.sh"

# ===================================================================================
# μƒλ΅μ΄ λ…λ Ήμ–΄ ν•¨μλ“¤ (API κΈ°λ°)
# ===================================================================================

# λ””μ¤ν¬ λ©λ΅ ν‘μ‹ (κ°μ„ λ¨)
cmd_list_disks() {
    local format="${1:-table}"
    local filter="${2:-}"
    
    print_header "π’Ύ λ””μ¤ν¬ κ΄€λ¦¬"
    echo ""
    
    case "$format" in
        "available")
            disk_list_unmounted "table"
            ;;
        "mounted")
            disk_list_mounted "$filter" "table"
            ;;
        "raid-ready")
            disk_list_available_for_raid "table"
            ;;
        *)
            echo "μ‚¬μ© κ°€λ¥ν• λ””μ¤ν¬ λ©λ΅:"
            disk_list_unmounted "table"
            echo ""
            echo "ν„μ¬ λ§μ΄νΈλ λ””μ¤ν¬:"
            disk_list_mounted "$filter" "table"
            ;;
    esac
}

# RAID λ°°μ—΄ λ©λ΅ ν‘μ‹ (κ°μ„ λ¨)
cmd_list_raids() {
    local format="${1:-detailed}"
    
    print_header "β΅ RAID κ΄€λ¦¬"
    raid_get_system_status "$format"
}

# μ‹μ¤ν… μ „μ²΄ κ²€μ‚¬ (κ°μ„ λ¨)
cmd_system_check() {
    print_header "π” μ‹μ¤ν… μ „μ²΄ κ±΄κ°• μƒνƒ κ²€μ‚¬"
    
    print_step "1/3" "λ””μ¤ν¬ μƒνƒ κ²€μ‚¬ μ¤‘..."
    echo ""
    disk_list_unmounted "table"
    
    echo ""
    print_step "2/3" "RAID μƒνƒ κ²€μ‚¬ μ¤‘..."
    echo ""
    if ! raid_health_check_system false; then
        print_warning "RAID μ‹μ¤ν…μ— λ¬Έμ κ°€ λ°κ²¬λμ—μµλ‹λ‹¤"
    fi
    
    echo ""
    print_step "3/3" "fstab κ²€μ¦ μ¤‘..."
    echo ""
    if ! fstab_validate_existing false; then
        print_warning "fstab μ„¤μ •μ— λ¬Έμ κ°€ λ°κ²¬λμ—μµλ‹λ‹¤"
    fi
    
    echo ""
    print_success "μ‹μ¤ν… μ „μ²΄ κ²€μ‚¬ μ™„λ£"
}

# μƒλ΅μ΄ RAID μƒμ„± λ…λ Ήμ–΄
cmd_create_raid() {
    local level="$1"
    local mountpoint="$2"
    local fstype="${3:-ext4}"
    shift 3
    local disk_ids=("$@")
    
    if [[ -z "$level" || -z "$mountpoint" || ${#disk_ids[@]} -eq 0 ]]; then
        print_error "μ‚¬μ©λ²•: create-raid <λ λ²¨> <λ§μ΄νΈν¬μΈνΈ> [νμΌμ‹μ¤ν…] <λ””μ¤ν¬1> <λ””μ¤ν¬2> ..."
        print_info "μμ‹: create-raid 1 /data ext4 sdb sdc"
        return 1
    fi
    
    raid_create_complete "$level" "$mountpoint" "$fstype" "defaults" "${disk_ids[@]}"
}

# RAID μ κ±° λ…λ Ήμ–΄
cmd_remove_raid() {
    local raid_device="$1"
    local wipe_disks="${2:-false}"
    
    if [[ -z "$raid_device" ]]; then
        print_error "μ‚¬μ©λ²•: remove-raid <RAID_λ””λ°”μ΄μ¤> [wipe]"
        print_info "μμ‹: remove-raid /dev/md0"
        print_info "       remove-raid /dev/md0 wipe  # λ””μ¤ν¬ μ™„μ „ μ‚­μ "
        return 1
    fi
    
    [[ "$wipe_disks" == "wipe" ]] && wipe_disks="true" || wipe_disks="false"
    
    raid_remove_array "$raid_device" true "$wipe_disks"
}

# fstab κ΄€λ¦¬ λ…λ Ήμ–΄
cmd_add_fstab() {
    local device_id="$1"
    local mountpoint="$2"
    local fstype="${3:-ext4}"
    local options="${4:-defaults}"
    
    if [[ -z "$device_id" || -z "$mountpoint" ]]; then
        print_error "μ‚¬μ©λ²•: add-fstab <λ””μ¤ν¬_ID> <λ§μ΄νΈν¬μΈνΈ> [νμΌμ‹μ¤ν…] [μµμ…]"
        print_info "μμ‹: add-fstab UUID=12345678-1234-1234-1234-123456789012 /data"
        print_info "      add-fstab /dev/sdb1 /backup ext4 defaults"
        return 1
    fi
    
    fstab_add_entry_safe "$device_id" "$mountpoint" "$fstype" "$options"
}

cmd_remove_fstab() {
    local identifier="$1"
    
    if [[ -z "$identifier" ]]; then
        print_error "μ‚¬μ©λ²•: remove-fstab <λ§μ΄νΈν¬μΈνΈ_λλ”_λ””λ°”μ΄μ¤>"
        print_info "μμ‹: remove-fstab /data"
        print_info "      remove-fstab /dev/sdb1"
        return 1
    fi
    
    fstab_remove_entry_safe "$identifier" true true
}

cmd_list_fstab() {
    local format="${1:-detailed}"
    
    print_header "π“‹ fstab κ΄€λ¦¬"
    fstab_get_entries "" "$format"
}

# μ„μ‹ λ§μ΄νΈ λ…λ Ήμ–΄
cmd_mount_temp() {
    local device_id="$1"
    local mountpoint="$2"
    local fstype="${3:-auto}"
    
    if [[ -z "$device_id" || -z "$mountpoint" ]]; then
        print_error "μ‚¬μ©λ²•: mount-temp <λ””μ¤ν¬_ID> <λ§μ΄νΈν¬μΈνΈ> [νμΌμ‹μ¤ν…]"
        print_info "μμ‹: mount-temp UUID=12345... /mnt/temp"
        print_info "      mount-temp /dev/sdb1 /mnt/backup ext4"
        return 1
    fi
    
    disk_mount_temporary "$device_id" "$mountpoint" "$fstype"
}

cmd_unmount_temp() {
    local target="$1"
    local force="${2:-false}"
    
    if [[ -z "$target" ]]; then
        print_error "μ‚¬μ©λ²•: unmount-temp <λ§μ΄νΈν¬μΈνΈ_λλ”_λ””λ°”μ΄μ¤> [force]"
        print_info "μμ‹: unmount-temp /mnt/temp"
        print_info "      unmount-temp /dev/sdb1 force"
        return 1
    fi
    
    [[ "$force" == "force" ]] && force="true" || force="false"
    
    disk_unmount_temporary "$target" "$force" true
}

# λ””μ¤ν¬ μ •λ³΄ μ΅°ν λ…λ Ήμ–΄
cmd_disk_info() {
    local disk_id="$1"
    local format="${2:-detailed}"
    
    if [[ -z "$disk_id" ]]; then
        print_error "μ‚¬μ©λ²•: disk-info <λ””μ¤ν¬_ID> [ν•μ‹]"
        print_info "μμ‹: disk-info UUID=12345..."
        print_info "      disk-info /dev/sdb1 simple"
        return 1
    fi
    
    disk_get_info "$disk_id" "$format"
}

# RAID λ¶„μ„ λ…λ Ήμ–΄
cmd_analyze_raid() {
    local raid_device="$1"
    local check_performance="${2:-false}"
    
    if [[ -z "$raid_device" ]]; then
        print_error "μ‚¬μ©λ²•: analyze-raid <RAID_λ””λ°”μ΄μ¤> [performance]"
        print_info "μμ‹: analyze-raid /dev/md0"
        print_info "      analyze-raid /dev/md0 performance"
        return 1
    fi
    
    [[ "$check_performance" == "performance" ]] && check_performance="true" || check_performance="false"
    
    raid_analyze_array "$raid_device" "$check_performance"
}

# μ‹μ¤ν… μμ • λ…λ Ήμ–΄
cmd_fix_system() {
    print_header "π”§ μ‹μ¤ν… μλ™ μμ •"
    
    print_step "1/2" "fstab fail-safe μµμ… μμ • μ¤‘..."
    if ! check_system_fail_safe; then
        if confirm_action "λ¨λ“  fstab ν•­λ©μ— fail-safe μµμ…μ„ μ¶”κ°€ν•μ‹κ² μµλ‹κΉ?"; then
            auto_fix_system_fail_safe
        fi
    else
        print_success "fstab fail-safe μµμ…μ΄ λ¨λ‘ μ μ©λμ–΄ μμµλ‹λ‹¤"
    fi
    
    echo ""
    print_step "2/2" "RAID μ‹μ¤ν… λ¬Έμ  μμ • μ¤‘..."
    raid_auto_fix_issues
    
    echo ""
    print_success "μ‹μ¤ν… μλ™ μμ • μ™„λ£"
}

# ===================================================================================
# κΈ°μ΅΄ νΈν™μ„± λ…λ Ήμ–΄λ“¤ (APIλ΅ λ¦¬ν©ν„°λ§)
# ===================================================================================

# RAID μ„¤μ • (κΈ°μ΅΄ νΈν™μ„±)
cmd_setup_raid() {
    print_header "π€ λ€ν™”ν• RAID μ„¤μ •"
    
    # μ‚¬μ© κ°€λ¥ν• λ””μ¤ν¬ ν‘μ‹
    echo ""
    print_info "RAID μƒμ„±μ— μ‚¬μ© κ°€λ¥ν• λ””μ¤ν¬:"
    disk_list_available_for_raid "table"
    
    echo ""
    
    # RAID λ λ²¨ μ„ νƒ
    print_info "μ§€μ›ν•λ” RAID λ λ²¨:"
    echo "  RAID 0: μ¤νΈλΌμ΄ν•‘ (μ„±λ¥ ν–¥μƒ, μ¤‘λ³µμ„± μ—†μ) - μµμ† 2κ° λ””μ¤ν¬"
    echo "  RAID 1: λ―Έλ¬λ§ (μ¤‘λ³µμ„± μ κ³µ) - μµμ† 2κ° λ””μ¤ν¬"  
    echo "  RAID 5: ν¨λ¦¬ν‹° μ¤νΈλΌμ΄ν•‘ (μ„±λ¥+μ¤‘λ³µμ„±) - μµμ† 3κ° λ””μ¤ν¬"
    echo "  RAID 10: λ―Έλ¬+μ¤νΈλΌμ΄ν”„ (κ³ μ„±λ¥+κ³ μ•μ •μ„±) - μµμ† 4κ° λ””μ¤ν¬"
    echo ""
    
    read -rp "RAID λ λ²¨μ„ μ„ νƒν•μ„Έμ” (0/1/5/10): " raid_level
    
    case "$raid_level" in
        0|1|5|10) ;;
        *) 
            print_error "μ§€μ›ν•μ§€ μ•λ” RAID λ λ²¨μ…λ‹λ‹¤"
            return 1
            ;;
    esac
    
    # λ§μ΄νΈν¬μΈνΈ μ…λ ¥
    read -rp "λ§μ΄νΈν¬μΈνΈλ¥Ό μ…λ ¥ν•μ„Έμ” (μ: /data): " mountpoint
    
    if [[ -z "$mountpoint" ]]; then
        print_error "λ§μ΄νΈν¬μΈνΈκ°€ ν•„μ”ν•©λ‹λ‹¤"
        return 1
    fi
    
    # νμΌμ‹μ¤ν… μ„ νƒ
    echo ""
    print_info "νμΌμ‹μ¤ν… μΆ…λ¥:"
    echo "  ext4: λ²”μ©μ , μ•μ •μ  (κ¶μ¥)"
    echo "  xfs: λ€μ©λ‰ νμΌμ— μµμ ν™”"
    echo ""
    
    read -rp "νμΌμ‹μ¤ν…μ„ μ„ νƒν•μ„Έμ” [ext4]: " fstype
    fstype="${fstype:-ext4}"
    
    # λ””μ¤ν¬ μ„ νƒ
    echo ""
    print_info "μ‚¬μ©ν•  λ””μ¤ν¬λ¥Ό μ„ νƒν•μ„Έμ” (κ³µλ°±μΌλ΅ κµ¬λ¶„)"
    print_info "μμ‹: sdb sdc sdd"
    read -rp "λ””μ¤ν¬ λ©λ΅: " -a disk_list
    
    if [[ ${#disk_list[@]} -eq 0 ]]; then
        print_error "μµμ† 1κ° μ΄μƒμ λ””μ¤ν¬κ°€ ν•„μ”ν•©λ‹λ‹¤"
        return 1
    fi
    
    # RAID μƒμ„± μ‹¤ν–‰
    raid_create_complete "$raid_level" "$mountpoint" "$fstype" "defaults" "${disk_list[@]}"
}

# ===================================================================================
# λ„μ›€λ§ μ‹μ¤ν…
# ===================================================================================

show_help() {
    cat << 'EOF'
Ubuntu Disk Toolkit v3.0.0 - Enhanced Storage Management

μ‚¬μ©λ²•: ubuntu-disk-toolkit <λ…λ Ήμ–΄> [μµμ…...]

π“‹ μ •λ³΄ μ΅°ν:
  list-disks [ν•μ‹]              λ””μ¤ν¬ λ©λ΅ ν‘μ‹
    ν•μ‹: table(κΈ°λ³Έ), available, mounted, raid-ready
  list-raids [ν•μ‹]              RAID λ°°μ—΄ λ©λ΅ ν‘μ‹  
    ν•μ‹: detailed(κΈ°λ³Έ), simple, summary
  list-fstab [ν•μ‹]              fstab ν•­λ© ν‘μ‹
    ν•μ‹: detailed(κΈ°λ³Έ), table, simple
  disk-info <ID> [ν•μ‹]          λ””μ¤ν¬ μƒμ„Έ μ •λ³΄
  analyze-raid <λ””λ°”μ΄μ¤> [perf] RAID μƒμ„Έ λ¶„μ„

π”§ RAID κ΄€λ¦¬:
  create-raid <λ λ²¨> <λ§μ΄νΈν¬μΈνΈ> [FS] <λ””μ¤ν¬...>
    μμ‹: create-raid 1 /data ext4 sdb sdc
  remove-raid <λ””λ°”μ΄μ¤> [wipe]  RAID μ κ±°
  setup-raid                     λ€ν™”ν• RAID μ„¤μ •

π“ fstab κ΄€λ¦¬:
  add-fstab <ID> <λ§μ΄νΈν¬μΈνΈ> [FS] [μµμ…]
    μμ‹: add-fstab UUID=123... /data ext4 defaults
  remove-fstab <μ‹λ³„μ>          fstab ν•­λ© μ κ±°

π’Ύ μ„μ‹ λ§μ΄νΈ:
  mount-temp <ID> <λ§μ΄νΈν¬μΈνΈ> [FS]    μ„μ‹ λ§μ΄νΈ
  unmount-temp <λ€μƒ> [force]            μ„μ‹ μ–Έλ§μ΄νΈ

π” μ‹μ¤ν… κ΄€λ¦¬:
  check-system                   μ „μ²΄ μ‹μ¤ν… κ²€μ‚¬
  fix-system                     μλ™ λ¬Έμ  μμ •

κΈ°μ΅΄ νΈν™ λ…λ Ήμ–΄:
  disks, raids, demo, setup      κΈ°μ΅΄ μ¤νƒ€μΌ λ…λ Ήμ–΄

ID ν•μ‹: UUID=..., PARTUUID=..., LABEL=..., /dev/sdX, sdX
EOF
}

show_command_list() {
    echo "μ‚¬μ© κ°€λ¥ν• λ…λ Ήμ–΄:"
    echo ""
    echo "π“‹ μ •λ³΄ μ΅°ν:"
    echo "  list-disks, list-raids, list-fstab, disk-info, analyze-raid"
    echo ""
    echo "π”§ RAID κ΄€λ¦¬:"
    echo "  create-raid, remove-raid, setup-raid"
    echo ""
    echo "π“ fstab κ΄€λ¦¬:"
    echo "  add-fstab, remove-fstab"
    echo ""
    echo "π’Ύ μ„μ‹ λ§μ΄νΈ:"
    echo "  mount-temp, unmount-temp"
    echo ""
    echo "π” μ‹μ¤ν… κ΄€λ¦¬:"
    echo "  check-system, fix-system"
    echo ""
    echo "κΈ°μ΅΄ νΈν™μ„±:"
    echo "  disks, raids, demo, setup"
    echo ""
    echo "μμ„Έν• μ‚¬μ©λ²•: ubuntu-disk-toolkit help"
}

# ===================================================================================
# λ©”μΈ μ‹¤ν–‰ λ΅μ§
# ===================================================================================

main() {
    # μΈμκ°€ μ—†λ” κ²½μ° λ…λ Ήμ–΄ λ©λ΅ ν‘μ‹
    if [[ $# -eq 0 ]]; then
        show_command_list
        return 0
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        # μƒλ΅μ΄ API κΈ°λ° λ…λ Ήμ–΄λ“¤
        "list-disks")
            cmd_list_disks "$@"
            ;;
        "list-raids")
            cmd_list_raids "$@"
            ;;
        "list-fstab")
            cmd_list_fstab "$@"
            ;;
        "create-raid")
            cmd_create_raid "$@"
            ;;
        "remove-raid")
            cmd_remove_raid "$@"
            ;;
        "add-fstab")
            cmd_add_fstab "$@"
            ;;
        "remove-fstab")
            cmd_remove_fstab "$@"
            ;;
        "mount-temp")
            cmd_mount_temp "$@"
            ;;
        "unmount-temp")
            cmd_unmount_temp "$@"
            ;;
        "disk-info")
            cmd_disk_info "$@"
            ;;
        "analyze-raid")
            cmd_analyze_raid "$@"
            ;;
        "check-system")
            cmd_system_check "$@"
            ;;
        "fix-system")
            cmd_fix_system "$@"
            ;;
        "setup-raid")
            cmd_setup_raid "$@"
            ;;
        
        # κΈ°μ΅΄ νΈν™μ„± λ…λ Ήμ–΄λ“¤ (λ³„μΉ­)
        "disks")
            cmd_list_disks table
            ;;
        "raids")
            cmd_list_raids detailed
            ;;
        "demo")
            print_header "π¬ Ubuntu Disk Toolkit Demo"
            echo ""
            print_info "μ‹μ¤ν… μƒνƒ κ°μ”:"
            cmd_system_check
            ;;
        "setup")
            cmd_setup_raid
            ;;
        
        # λ„μ›€λ§
        "help"|"-h"|"--help")
            show_help
            ;;
        "commands")
            show_command_list
            ;;
        
        # μ• μ μ—†λ” λ…λ Ήμ–΄
        *)
            print_error "μ• μ μ—†λ” λ…λ Ήμ–΄: $command"
            echo ""
            show_command_list
            return 1
            ;;
    esac
}

# μ¤ν¬λ¦½νΈ μ‹¤ν–‰
main "$@" 