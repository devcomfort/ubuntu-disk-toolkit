#!/bin/bash

# ===================================================================================
# ubuntu-disk-toolkit - Ubuntu Storage & Disk Management Toolkit
# ===================================================================================

set -euo pipefail

# ìŠ¤í¬ë¦½íŠ¸ ì •ë³´
SCRIPT_NAME="ubuntu-disk-toolkit"
VERSION="2.0.0"
DESCRIPTION="Ubuntu Storage & Disk Management Toolkit"

# ê²½ë¡œ ì„¤ì •
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/../lib/common.sh" ]]; then
    LIB_DIR="$SCRIPT_DIR/../lib"
else
    LIB_DIR="/usr/local/lib/ubuntu-disk-toolkit"
fi

# ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
source "$LIB_DIR/common.sh"
source "$LIB_DIR/ui-functions.sh"
source "$LIB_DIR/disk-functions.sh"
source "$LIB_DIR/raid-functions.sh"

# ===================================================================================
# ëª…ë ¹ì–´ í•¨ìˆ˜ë“¤
# ===================================================================================

# ë””ìŠ¤í¬ ëª©ë¡ í‘œì‹œ
cmd_list_disks() {
    local format="${1:-detailed}"
    echo "ğŸ’¾ ì‚¬ìš© ê°€ëŠ¥í•œ ë””ìŠ¤í¬ ëª©ë¡:"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    get_all_disks false "$format"
}

# RAID ë°°ì—´ ëª©ë¡ í‘œì‹œ  
cmd_list_raids() {
    local format="${1:-summary}"
    echo "âš¡ RAID ë°°ì—´ ìƒíƒœ:"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    get_raid_arrays
}

# ì‹œìŠ¤í…œ ì „ì²´ ê²€ì‚¬
cmd_system_check() {
    echo "ğŸ” ì‹œìŠ¤í…œ ì „ì²´ ê±´ê°• ìƒíƒœ ê²€ì‚¬ ì¤‘..."
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # ì‹œìŠ¤í…œ ì •ë³´
    ./bin/check-system info
    echo ""
    
    # ë””ìŠ¤í¬ ìƒíƒœ
    cmd_list_disks
    echo ""
    
    # RAID ìƒíƒœ  
    cmd_list_raids
}

# RAID ì„¤ì • (placeholder)
cmd_setup_raid() {
    print_info "RAID ì„¤ì • ê¸°ëŠ¥ì€ ëŒ€í™”í˜• ëª¨ë“œë¡œ ì œê³µë©ë‹ˆë‹¤."
    print_info "ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”: ubuntu-disk-toolkit manage-disk"
}

# ===================================================================================
# ì‚¬ìš©ë²• í‘œì‹œ
# ===================================================================================

show_usage() {
    cat << 'EOF'

Ubuntu Disk Toolkit - í†µí•© ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ ë„êµ¬

ì‚¬ìš©ë²•:
  ubuntu-disk-toolkit <command> [options]

ğŸ“Š ì‹œìŠ¤í…œ ê´€ë¦¬:
  check-system     ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ ê²€ì‚¬ ë° ì„¤ì •
  list-disks       ë””ìŠ¤í¬ ëª©ë¡ ë° ìƒíƒœ í‘œì‹œ
  list-raids       RAID ë°°ì—´ ëª©ë¡ í‘œì‹œ

ğŸ”§ ë””ìŠ¤í¬ ê´€ë¦¬:
  manage-disk      ë””ìŠ¤í¬ ë§ˆìš´íŠ¸/ì–¸ë§ˆìš´íŠ¸ ê´€ë¦¬
  manage-fstab     fstab í•­ëª© ê´€ë¦¬

âš¡ RAID ê´€ë¦¬:
  setup-raid       ìƒˆë¡œìš´ RAID ë°°ì—´ ìƒì„±
  remove-raid      RAID ë°°ì—´ ì œê±°
  check-raids      RAID ìƒíƒœ í™•ì¸

ğŸ” ì§„ë‹¨ ë„êµ¬:
  check            ì‹œìŠ¤í…œ ì „ì²´ ê±´ê°• ìƒíƒœ í™•ì¸
  analyze-health   ì¢…í•© ë””ìŠ¤í¬ ì—°ê²° ë¶„ì„

ğŸ†˜ ë„ì›€ë§:
  ubuntu-disk-toolkit <command> --help    íŠ¹ì • ëª…ë ¹ì–´ ë„ì›€ë§
  ubuntu-disk-toolkit --version           ë²„ì „ ì •ë³´

ì˜ˆì‹œ:
  # ì‹œìŠ¤í…œ ì„¤ì • ë° í™•ì¸
  ubuntu-disk-toolkit check-system --auto-install
  ubuntu-disk-toolkit list-disks --all
  
  # RAID ê´€ë¦¬
  ubuntu-disk-toolkit setup-raid --level 1 --disks /dev/sda,/dev/sdb
  ubuntu-disk-toolkit list-raids --detailed
  
  # ë””ìŠ¤í¬ ê´€ë¦¬
  ubuntu-disk-toolkit manage-disk mount
  ubuntu-disk-toolkit manage-fstab add
  
  # ì¢…í•© ì§„ë‹¨
  ubuntu-disk-toolkit analyze-health

ğŸ’¡ Tip: ëŒ€ë¶€ë¶„ì˜ ëª…ë ¹ì–´ëŠ” interactive ëª¨ë“œë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
      ì˜µì…˜ ì—†ì´ ì‹¤í–‰í•˜ë©´ ë‹¨ê³„ë³„ ì•ˆë‚´ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

EOF
}

# ë²„ì „ ì •ë³´ í‘œì‹œ
show_version() {
    echo "$SCRIPT_NAME version $VERSION"
    echo "$DESCRIPTION"
}

# ë©”ì¸ í•¨ìˆ˜
main() {
    if [[ $# -eq 0 ]]; then
        show_usage
        exit 0
    fi

    case "${1:-}" in
        # ë„ì›€ë§ ë° ì •ë³´
        "-h"|"--help")
            show_usage
            exit 0
            ;;
        "--version")
            show_version
            exit 0
            ;;
            
        # ì‹œìŠ¤í…œ ê´€ë¦¬
        "check-system")
            # í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ bin ê²½ë¡œì—ì„œ ì‹¤í–‰
            local bin_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            exec "$bin_dir/check-system" "${@:2}"
            ;;
            
        # ê¸°ë³¸ ëª…ë ¹ì–´ë“¤
        "list-disks")
            cmd_list_disks "${@:2}"
            ;;
        "list-raids")
            cmd_list_raids "${@:2}"
            ;;
            
        # ë””ìŠ¤í¬ ê´€ë¦¬
        "manage-disk")
            local bin_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            exec "$bin_dir/manage-disk" "${@:2}"
            ;;
        "manage-fstab")
            local bin_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            exec "$bin_dir/manage-fstab" "${@:2}"
            ;;
            
        # RAID ê´€ë¦¬
        "setup-raid")
            cmd_setup_raid "${@:2}"
            ;;
        "remove-raid")
            print_warning "RAID ì œê±°ëŠ” í˜„ì¬ ìˆ˜ë™ìœ¼ë¡œë§Œ ì§€ì›ë©ë‹ˆë‹¤."
            print_info "ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:"
            echo "  sudo mdadm --stop /dev/mdX"
            echo "  sudo mdadm --remove /dev/mdX"
            echo "  sudo mdadm --zero-superblock /dev/sdX /dev/sdY"
            ;;
        "check-raids")
            cmd_list_raids --detailed "${@:2}"
            ;;
            
        # ì§„ë‹¨ ë„êµ¬
        "check")
            cmd_system_check "${@:2}"
            ;;
        "analyze-health")
            local bin_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            exec "$bin_dir/check-disk-health" "${@:2}"
            ;;
            
        *)
            print_error "ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: $1"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@" 